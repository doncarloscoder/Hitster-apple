<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hitster Player</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  padding:20px;
}
video {
  width:100%;
  max-width:400px;
  border-radius:12px;
  margin-top:20px;
}
button {
  padding:14px 24px;
  font-size:18px;
  border-radius:12px;
  border:none;
  background:#1DB954;
  color:white;
  margin-top:15px;
}
.status {
  margin-top:15px;
  min-height:24px;
}
</style>
</head>

<body>

<h1>ðŸŽµ Hitster Universal</h1>

<button onclick="startScanner()">Starta scanning</button>

<br>
<video id="video" playsinline></video>
<div class="status" id="status">Redo</div>

<script>

let mapping = {};
let codeReader;
let stream;

const video = document.getElementById('video');
const statusEl = document.getElementById('status');

fetch("mapping.json")
  .then(r => r.json())
  .then(data => {
    mapping = data;
    console.log("Mapping laddad:", Object.keys(mapping).length, "lÃ¥tar");
  })
  .catch(err => {
    statusEl.innerText = "Kunde inte ladda mapping.json";
    console.error(err);
  });

// Extrahera songId direkt om det redan Ã¤r /songs/{id}
function extractSongIdFromUrl(url) {
  const match = url.match(/songs\/(\d+)/);
  return match ? match[1] : null;
}

// FÃ¶lj redirect fÃ¶r gamla URL-format
async function resolveSongId(originalUrl) {
  try {
    const response = await fetch(originalUrl, {
      method: "GET",
      redirect: "follow"
    });

    const finalUrl = response.url;
    const songId = extractSongIdFromUrl(finalUrl);

    return songId;
  } catch (err) {
    console.error("Redirect-fel:", err);
    return null;
  }
}

async function startScanner() {
  statusEl.innerText = "Startar kamera...";

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    });

    video.srcObject = stream;

    codeReader = new ZXing.BrowserQRCodeReader();

    statusEl.innerText = "Kamera aktiv â€“ hÃ¥ll kortet stilla";

    codeReader.decodeFromVideoElementContinuously(video, async (result, err) => {
      if (result) {
        const scannedUrl = result.getText();
        stopScanner();

        statusEl.innerText = "Bearbetar...";

        let songId = extractSongIdFromUrl(scannedUrl);

        if (!songId) {
          // Gamla format â†’ fÃ¶lj redirect
          songId = await resolveSongId(scannedUrl);
        }

        if (!songId) {
          statusEl.innerText = "Kunde inte hitta songId.";
          return;
        }

        statusEl.innerText = "Song ID: " + songId;

        if (mapping[songId]) {
          const spotifyId = mapping[songId];
          const spotifyUrl = "https://open.spotify.com/track/" + spotifyId;
          window.location.href = spotifyUrl;
        } else {
          statusEl.innerText = "SongId saknas i mapping.";
        }
      }
    });

  } catch (err) {
    statusEl.innerText = "Kamera-fel: " + err.message;
    console.error(err);
  }
}

function stopScanner() {
  if (codeReader) {
    codeReader.reset();
  }
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
}

</script>

</body>
</html>
