<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Hitster → Apple Music</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR-scanner bibliotek -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem;
      background: #111;
      color: #eee;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 1rem auto;
    }
    #log {
      margin-top: 1rem;
      font-size: 0.9rem;
      white-space: pre-wrap;
      background: #222;
      padding: 0.75rem;
      border-radius: 0.5rem;
    }
    .status-ok { color: #7CFC00; }
    .status-error { color: #ff6b6b; }
    button {
      padding: 0.6rem 1rem;
      border-radius: 0.5rem;
      border: none;
      background: #444;
      color: #eee;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    button:active {
      background: #666;
    }
  </style>
</head>
<body>
  <h1>Hitster → Apple Music</h1>
  <p>Scanna ett Hitster-kort så öppnas låten i Apple Music (om möjligt).</p>

  <div id="reader"></div>

  <button id="restart-btn" style="display:none;">Scanna igen</button>

  <div id="log"></div>

  <script>
    // ==============================
    // 1. Din Hitster-ID → Spotify-ID mappning
    // ==============================
    //
    // Byt ut innehållet i spotifyMap mot din riktiga lista.
    // Nyckeln = Hitster-ID (t.ex. "287"), värdet = Spotify track ID.
    //
    const spotifyMap = {
      "287": "3vZO25GdYuqFrR1kzZADnp",
      "571": "0KMGf0ebdR8aazf1PoHEdb"
      // ... klistra in hela din JSON-lista här ...
    };

    // ==============================
    // 2. Hjälpfunktioner
    // ==============================

    const logEl = document.getElementById("log");
    const restartBtn = document.getElementById("restart-btn");
    let html5QrCode = null;

    function log(message, type = "info") {
      const prefix =
        type === "error" ? "❌ " :
        type === "ok" ? "✅ " :
        "ℹ️ ";
      const cssClass =
        type === "error" ? "status-error" :
        type === "ok" ? "status-ok" :
        "";
      logEl.innerHTML = `<span class="${cssClass}">${prefix}${message}</span>`;
      console.log(message);
    }

    function extractHitsterIdFromUrl(url) {
      try {
        const u = new URL(url);
        const parts = u.pathname.split("/").filter(Boolean);
        // Ex: /resources/songs/287 → ["resources","songs","287"]
        return parts[parts.length - 1];
      } catch (e) {
        return null;
      }
    }

    async function getAppleMusicUrlFromSpotifyId(spotifyId) {
      const apiUrl =
        `https://api.song.link/v1-alpha.1/links?platform=spotify&type=song&id=${encodeURIComponent(spotifyId)}`;

      const res = await fetch(apiUrl);
      if (!res.ok) {
        throw new Error("Odesli svarade inte OK: " + res.status);
      }

      const data = await res.json();
      const links = data.linksByPlatform || {};

      if (links.appleMusic && links.appleMusic.url) {
        return { url: links.appleMusic.url, platform: "appleMusic" };
      } else if (links.spotify && links.spotify.url) {
        // fallback om Apple saknas
        return { url: links.spotify.url, platform: "spotify" };
      } else {
        throw new Error("Hittade varken Apple Music eller Spotify-länk i svaret.");
      }
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }
    }

    function showRestartButton() {
      restartBtn.style.display = "inline-block";
    }

    function hideRestartButton() {
      restartBtn.style.display = "none";
    }

    // ==============================
    // 3. QR-scanner setup
    // ==============================

    async function startScanner() {
      hideRestartButton();
      log("Startar kamera…");

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      };

      html5QrCode = new Html5Qrcode("reader");

      html5QrCode
        .start(
          { facingMode: "environment" },
          config,
          onScanSuccess,
          (errorMessage) => {
            // Ignorera kontinuerliga decode-fel
          }
        )
        .then(() => {
          log("Kamera igång. Rikta mot Hitster-kortet.");
        })
        .catch((err) => {
          log("Kunde inte starta kameran: " + err, "error");
        });
    }

    async function onScanSuccess(decodedText, decodedResult) {
      stopScanner();
      log(`Läste QR: ${decodedText}`);

      try {
        // 1. Extrahera Hitster-ID
        const hitsterId = extractHitsterIdFromUrl(decodedText);
        if (!hitsterId) {
          throw new Error("Kunde inte tolka Hitster-ID från URL.");
        }
        log(`Hitster-ID: ${hitsterId}`);

        // 2. Slå upp Spotify-ID
        const spotifyId = spotifyMap[hitsterId];
        if (!spotifyId) {
          throw new Error(`Ingen Spotify-ID hittades för Hitster-ID ${hitsterId}.`);
        }
        log(`Spotify-ID: ${spotifyId}`);

        // 3. Hämta Apple Music-länk via Odesli
        log("Slår upp Apple Music-länk via Odesli…");
        const { url, platform } = await getAppleMusicUrlFromSpotifyId(spotifyId);

        if (platform === "appleMusic") {
          log(`Öppnar i Apple Music…`, "ok");
        } else {
          log(`Hittade ingen Apple Music-länk, öppnar Spotify istället.`, "ok");
        }

        // 4. Redirect
        window.location.href = url;

      } catch (err) {
        log("Fel: " + err.message, "error");
        showRestartButton();
      }
    }

    // ==============================
    // 4. Init
    // ==============================

    restartBtn.addEventListener("click", () => {
      log("");
      startScanner();
    });

    // Starta direkt
    startScanner();
  </script>
</body>
</html>
