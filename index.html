<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hitster Player</title>

<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
body {
  background:#111;
  color:white;
  text-align:center;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  padding:20px;
}
video {
  width:100%;
  max-width:400px;
  border-radius:12px;
  margin-top:20px;
}
button {
  padding:14px 24px;
  font-size:18px;
  border-radius:12px;
  border:none;
  background:#1DB954;
  color:white;
  margin-top:15px;
}
.status {
  margin-top:15px;
  min-height:24px;
}
</style>
</head>

<body>

<h1>ðŸŽµ Hitster</h1>

<button onclick="startScanner()">Starta scanning</button>

<br>
<video id="video" playsinline></video>
<div class="status" id="status">Redo</div>

<script>

let mapping = {};
let codeReader;
let stream;

const video = document.getElementById('video');
const statusEl = document.getElementById('status');

// Ladda mapping.json
fetch("mapping.json")
  .then(r => r.json())
  .then(data => {
    mapping = data;
    console.log("Mapping laddad:", Object.keys(mapping).length, "kort");
  })
  .catch(err => {
    statusEl.innerText = "Kunde inte ladda mapping.json";
    console.error(err);
  });

// Extrahera kortnummer frÃ¥n Hitster URL
function extractCardNumber(text) {
  const matches = text.match(/\d+/g);
  return matches ? parseInt(matches[matches.length - 1], 10).toString() : null;
}

async function startScanner() {
  statusEl.innerText = "Startar kamera...";

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: "environment" },
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      }
    });

    video.srcObject = stream;

    codeReader = new ZXing.BrowserQRCodeReader();

    statusEl.innerText = "Kamera aktiv â€“ hÃ¥ll kortet stilla";

    codeReader.decodeFromVideoElementContinuously(video, (result, err) => {
      if (result) {
        const text = result.getText();
        const cardNumber = extractCardNumber(text);

        if (!cardNumber) return;

        statusEl.innerText = "Kort: " + cardNumber;

        stopScanner();

        if (mapping[cardNumber]) {
          const spotifyId = mapping[cardNumber];
          const spotifyUrl = "https://open.spotify.com/track/" + spotifyId;
          window.location.href = spotifyUrl;
        } else {
          statusEl.innerText = "Kort saknas i mapping.";
        }
      }
    });

  } catch (err) {
    statusEl.innerText = "Kamera-fel: " + err.message;
    console.error(err);
  }
}

function stopScanner() {
  if (codeReader) {
    codeReader.reset();
  }
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }
}

</script>

</body>
</html>
